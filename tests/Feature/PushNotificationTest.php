<?php

namespace Tests\Feature;

use Alison\ProjectManagementAssistant\Models\Category;
use Alison\ProjectManagementAssistant\Models\Event;
use Alison\ProjectManagementAssistant\Models\Message;
use Alison\ProjectManagementAssistant\Models\Project;
use Alison\ProjectManagementAssistant\Models\Supervisor;
use Alison\ProjectManagementAssistant\Models\User;
use Alison\ProjectManagementAssistant\Notifications\NewChatMessageNotification;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Notification;
use NotificationChannels\WebPush\PushSubscription;
use NotificationChannels\WebPush\WebPushChannel;
use Spatie\Permission\Models\Role;
use Tests\TestCase;

class PushNotificationTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä–æ–ª–µ–π
        Role::create(['name' => 'admin']);
        Role::create(['name' => 'teacher']);
        Role::create(['name' => 'student']);
    }

    /** @test */
    public function user_can_create_push_subscription()
    {
        $user = User::factory()->create();
        $user->assignRole('student');

        $subscriptionData = [
            'endpoint' => 'https://fcm.googleapis.com/fcm/send/test-endpoint',
            'keys' => [
                'auth' => 'test-auth-key-12345',
                'p256dh' => 'test-p256dh-key-67890'
            ]
        ];

        $response = $this->actingAs($user)
            ->postJson('/push-subscriptions', $subscriptionData);

        $response->assertStatus(200)
            ->assertJson([
                'success' => true,
                'message' => 'Push –ø—ñ–¥–ø–∏—Å–∫–∞ —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∞'
            ]);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –ø—ñ–¥–ø–∏—Å–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
        $this->assertDatabaseHas('push_subscriptions', [
            'subscribable_id' => $user->id,
            'subscribable_type' => User::class,
            'endpoint' => $subscriptionData['endpoint'],
            'auth_token' => $subscriptionData['keys']['auth'],
            'public_key' => $subscriptionData['keys']['p256dh']
        ]);
    }

    /** @test */
    public function user_can_delete_push_subscription()
    {
        $user = User::factory()->create();
        $user->assignRole('student');

        // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—ñ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ –º–æ–¥–µ–ª—ñ
        $user->updatePushSubscription(
            'https://fcm.googleapis.com/fcm/send/test-endpoint',
            'test-public-key',
            'test-auth-token'
        );

        $subscription = $user->pushSubscriptions()->first();

        $response = $this->actingAs($user)
            ->deleteJson('/push-subscriptions', [
                'endpoint' => $subscription->endpoint
            ]);

        $response->assertStatus(200)
            ->assertJson([
                'success' => true,
                'message' => 'Push –ø—ñ–¥–ø–∏—Å–∫–∞ —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–∞'
            ]);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –ø—ñ–¥–ø–∏—Å–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–∞ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
        $this->assertDatabaseMissing('push_subscriptions', [
            'id' => $subscription->id
        ]);
    }

    /** @test */
    public function user_can_get_push_subscription_status()
    {
        $user = User::factory()->create();
        $user->assignRole('student');

        // –°–ø–æ—á–∞—Ç–∫—É –±–µ–∑ –ø—ñ–¥–ø–∏—Å–æ–∫
        $response = $this->actingAs($user)
            ->getJson('/push-subscriptions/status');

        $response->assertStatus(200)
            ->assertJson([
                'success' => true,
                'has_subscriptions' => false,
                'subscriptions_count' => 0
            ]);

        // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—ñ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ –º–æ–¥–µ–ª—ñ
        $user->updatePushSubscription(
            'https://fcm.googleapis.com/fcm/send/test-endpoint',
            'test-public-key',
            'test-auth-token'
        );

        // –¢–µ–ø–µ—Ä –∑ –ø—ñ–¥–ø–∏—Å–∫–æ—é
        $response = $this->actingAs($user)
            ->getJson('/push-subscriptions/status');

        $response->assertStatus(200)
            ->assertJson([
                'success' => true,
                'has_subscriptions' => true,
                'subscriptions_count' => 1
            ]);
    }

    /** @test */
    public function chat_notification_includes_webpush_channel_when_user_has_subscription()
    {
        Notification::fake();

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        $teacher = User::factory()->create();
        $teacher->assignRole('teacher');
        
        $student = User::factory()->create(['course_number' => 2]);
        $student->assignRole('student');

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è push –ø—ñ–¥–ø–∏—Å–∫–∏ –¥–ª—è –≤–∏–∫–ª–∞–¥–∞—á–∞
        $teacher->updatePushSubscription(
            'https://fcm.googleapis.com/fcm/send/test-endpoint',
            'test-public-key',
            'test-auth-token'
        );

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó —Ç–∞ –ø—Ä–æ–µ–∫—Ç—É
        $category = Category::factory()->create(['course_number' => 2]);
        $event = Event::factory()->create(['category_id' => $category->id]);
        
        $supervisor = Supervisor::factory()->create([
            'event_id' => $event->id,
            'user_id' => $teacher->id,
        ]);
        
        $project = Project::factory()->create([
            'event_id' => $event->id,
            'supervisor_id' => $supervisor->id,
            'assigned_to' => $student->id,
        ]);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        $message = Message::factory()->create([
            'project_id' => $project->id,
            'sender_id' => $student->id,
            'message' => '–¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'
        ]);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è notification
        $notification = new NewChatMessageNotification($message);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ webpush –∫–∞–Ω–∞–ª –≤–∫–ª—é—á–µ–Ω–æ
        $channels = $notification->via($teacher);
        $this->assertContains('mail', $channels);
        $this->assertContains(WebPushChannel::class, $channels);
    }

    /** @test */
    public function chat_notification_excludes_webpush_channel_when_user_has_no_subscription()
    {
        Notification::fake();

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –±–µ–∑ push –ø—ñ–¥–ø–∏—Å–æ–∫
        $teacher = User::factory()->create();
        $teacher->assignRole('teacher');
        
        $student = User::factory()->create(['course_number' => 2]);
        $student->assignRole('student');

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó —Ç–∞ –ø—Ä–æ–µ–∫—Ç—É
        $category = Category::factory()->create(['course_number' => 2]);
        $event = Event::factory()->create(['category_id' => $category->id]);
        
        $supervisor = Supervisor::factory()->create([
            'event_id' => $event->id,
            'user_id' => $teacher->id,
        ]);
        
        $project = Project::factory()->create([
            'event_id' => $event->id,
            'supervisor_id' => $supervisor->id,
            'assigned_to' => $student->id,
        ]);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        $message = Message::factory()->create([
            'project_id' => $project->id,
            'sender_id' => $student->id,
            'message' => '–¢–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è'
        ]);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è notification
        $notification = new NewChatMessageNotification($message);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ webpush –∫–∞–Ω–∞–ª –ù–ï –≤–∫–ª—é—á–µ–Ω–æ
        $channels = $notification->via($teacher);
        $this->assertContains('mail', $channels);
        $this->assertNotContains(WebPushChannel::class, $channels);
    }

    /** @test */
    public function webpush_message_contains_correct_data()
    {
        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        $teacher = User::factory()->create();
        $teacher->assignRole('teacher');
        
        $student = User::factory()->create(['course_number' => 2]);
        $student->assignRole('student');

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ—ó —Ç–∞ –ø—Ä–æ–µ–∫—Ç—É
        $category = Category::factory()->create(['course_number' => 2]);
        $event = Event::factory()->create(['category_id' => $category->id]);
        
        $supervisor = Supervisor::factory()->create([
            'event_id' => $event->id,
            'user_id' => $teacher->id,
        ]);
        
        $project = Project::factory()->create([
            'event_id' => $event->id,
            'supervisor_id' => $supervisor->id,
            'assigned_to' => $student->id,
        ]);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        $message = Message::factory()->create([
            'project_id' => $project->id,
            'sender_id' => $student->id,
            'message' => '–¶–µ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ webpush'
        ]);

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è notification
        $notification = new NewChatMessageNotification($message);

        // –û—Ç—Ä–∏–º—É—î–º–æ webpush –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        $webPushMessage = $notification->toWebPush($teacher);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ toArray()
        $messageArray = $webPushMessage->toArray();

        $this->assertEquals('üí¨ –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ', $messageArray['title']);
        $this->assertStringContainsString($student->full_name, $messageArray['body']);
        $this->assertStringContainsString('–¶–µ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ webpush', $messageArray['body']);
        $this->assertEquals('/favicon.ico', $messageArray['icon']);
        $this->assertEquals('chat-' . $project->id, $messageArray['tag']);

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–∞–Ω—ñ
        $this->assertEquals($project->id, $messageArray['data']['project_id']);
        $this->assertEquals($student->id, $messageArray['data']['sender_id']);
        $this->assertEquals('new_chat_message', $messageArray['data']['type']);
        $this->assertEquals(route('projects.show', $project), $messageArray['data']['url']);
    }
}
